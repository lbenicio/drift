name: Tests

on:
  push:
    branches:
      - main
      - develop
    paths:
      - "src/**"
      - "package.json"
      - "yarn.lock"
      - ".github/workflows/**"
  pull_request:
    branches:
      - main
      - develop
    paths:
      - "src/**"
      - "package.json"
      - "yarn.lock"
      - ".github/workflows/**"

env:
  NODE_ENV: test
  DATABASE_URL: postgresql://postgres:postgres@localhost:5432/drift_test
  NEXTAUTH_SECRET: test-secret-key-for-ci
  NEXTAUTH_URL: http://localhost:3000

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "24"

      - name: Enable Corepack
        run: corepack enable

      - name: Install dependencies
        run: yarn install --immutable

      - name: Run ESLint
        run: yarn eslint src --max-warnings 0

  test:
    name: Unit Tests
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: drift_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "24"

      - name: Enable Corepack
        run: corepack enable

      - name: Install dependencies
        run: yarn install --immutable

      - name: Generate Prisma Client
        run: yarn prisma generate

      - name: Run database migrations
        run: yarn prisma migrate deploy

      - name: Run unit tests
        run: yarn test:unit

  build:
    name: Build
    runs-on: ubuntu-latest
    needs: [lint, test]
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "24"

      - name: Enable Corepack
        run: corepack enable

      - name: Install dependencies
        run: yarn install --immutable

      - name: Generate Prisma Client
        run: yarn prisma generate

      - name: Build application
        run: yarn build:pkg
        env:
          SKIP_ENV_VALIDATION: true

  typecheck:
    name: Type Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "24"

      - name: Enable Corepack
        run: corepack enable

      - name: Install dependencies
        run: yarn install --immutable

      - name: Generate Prisma Client
        run: yarn prisma generate

      - name: Run TypeScript type check
        run: yarn tsc --noEmit

  summary:
    name: Summary
    runs-on: ubuntu-latest
    needs: [lint, test, build, typecheck]
    if: always()
    steps:
      - name: Generate Summary
        run: |
          # Helper function to get status emoji
          get_status() {
            case "$1" in
              success) echo "âœ…" ;;
              failure) echo "âŒ" ;;
              cancelled) echo "âš ï¸" ;;
              skipped) echo "â­ï¸" ;;
              *) echo "â“" ;;
            esac
          }

          # Get statuses
          LINT_STATUS="${{ needs.lint.result }}"
          TEST_STATUS="${{ needs.test.result }}"
          BUILD_STATUS="${{ needs.build.result }}"
          TYPECHECK_STATUS="${{ needs.typecheck.result }}"

          LINT_EMOJI=$(get_status "$LINT_STATUS")
          TEST_EMOJI=$(get_status "$TEST_STATUS")
          BUILD_EMOJI=$(get_status "$BUILD_STATUS")
          TYPECHECK_EMOJI=$(get_status "$TYPECHECK_STATUS")

          # Count results
          SUCCESS_COUNT=0
          FAIL_COUNT=0
          for status in "$LINT_STATUS" "$TEST_STATUS" "$BUILD_STATUS" "$TYPECHECK_STATUS"; do
            if [[ "$status" == "success" ]]; then
              ((SUCCESS_COUNT++))
            elif [[ "$status" == "failure" ]]; then
              ((FAIL_COUNT++))
            fi
          done

          # Determine overall status
          if [[ $FAIL_COUNT -eq 0 && $SUCCESS_COUNT -eq 4 ]]; then
            OVERALL="âœ… All Checks Passed"
            OVERALL_EMOJI="ğŸ‰"
          elif [[ $FAIL_COUNT -gt 0 ]]; then
            OVERALL="âŒ $FAIL_COUNT Check(s) Failed"
            OVERALL_EMOJI="ğŸ’”"
          else
            OVERALL="âš ï¸ Some Checks Skipped/Cancelled"
            OVERALL_EMOJI="ğŸ¤”"
          fi

          # Write summary
          cat >> $GITHUB_STEP_SUMMARY << EOF
          # $OVERALL_EMOJI CI Pipeline Results

          ## ğŸ“Š Test Results Summary

          | Job | Status | Result | Description |
          |-----|--------|--------|-------------|
          | ğŸ” Lint | $LINT_EMOJI | \`$LINT_STATUS\` | ESLint code quality checks |
          | ğŸ§ª Test | $TEST_EMOJI | \`$TEST_STATUS\` | Unit tests with Jest |
          | ğŸ—ï¸ Build | $BUILD_EMOJI | \`$BUILD_STATUS\` | Next.js production build |
          | ğŸ“ TypeCheck | $TYPECHECK_EMOJI | \`$TYPECHECK_STATUS\` | TypeScript type validation |

          ---

          ## ğŸ“ˆ Statistics

          | Metric | Count |
          |--------|-------|
          | âœ… Passed | $SUCCESS_COUNT |
          | âŒ Failed | $FAIL_COUNT |
          | ğŸ“Š Total | 4 |

          ---

          ## $OVERALL

          ### ğŸ“‹ Workflow Details

          | Property | Value |
          |----------|-------|
          | ğŸ”€ Branch | \`${{ github.ref_name }}\` |
          | ğŸ“ Commit | [\`${GITHUB_SHA:0:7}\`](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}) |
          | ğŸ‘¤ Actor | @${{ github.actor }} |
          | ğŸƒ Run ID | [${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) |
          | ğŸ”„ Run Number | #${{ github.run_number }} |
          | â±ï¸ Event | \`${{ github.event_name }}\` |

          ---

          ### ğŸ”§ Environment

          | Tool | Version |
          |------|---------|
          | ğŸ“¦ Node.js | 24.x |
          | ğŸ˜ PostgreSQL | 17 |
          | ğŸ“š Package Manager | Yarn |

          ---

          <sub>ğŸ¤– Generated by GitHub Actions â€¢ Drift CI/CD Pipeline</sub>
          EOF

      - name: Check for failures
        if: needs.lint.result == 'failure' || needs.test.result == 'failure' || needs.build.result == 'failure' || needs.typecheck.result == 'failure'
        run: |
          echo "âŒ One or more CI checks failed!"
          exit 1

name: Lint & Format

on:
  push:
    branches:
      - main
      - develop
    paths:
      - "src/**"
      - "*.js"
      - "*.mjs"
      - "*.ts"
      - "*.json"
      - ".prettierrc"
      - "eslint.config.mjs"
      - ".github/workflows/lint-format.yaml"
  pull_request:
    branches:
      - main
      - develop
    paths:
      - "src/**"
      - "*.js"
      - "*.mjs"
      - "*.ts"
      - "*.json"
      - ".prettierrc"
      - "eslint.config.mjs"
      - ".github/workflows/lint-format.yaml"

env:
  NODE_ENV: development

jobs:
  eslint:
    name: ESLint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "24"

      - name: Enable Corepack
        run: corepack enable

      - name: Install dependencies
        run: yarn install --immutable

      - name: Generate Prisma Client
        run: yarn prisma generate

      - name: Run ESLint
        run: yarn eslint src --max-warnings 0 --format stylish

  prettier:
    name: Prettier
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "24"

      - name: Enable Corepack
        run: corepack enable

      - name: Install dependencies
        run: yarn install --immutable

      - name: Check formatting with Prettier
        run: yarn prettier --check --config .prettierrc src

  summary:
    name: Summary
    runs-on: ubuntu-latest
    needs: [eslint, prettier]
    if: always()
    steps:
      - name: Generate Summary
        run: |
          # Helper function to get status emoji
          get_status() {
            case "$1" in
              success) echo "âœ…" ;;
              failure) echo "âŒ" ;;
              cancelled) echo "âš ï¸" ;;
              skipped) echo "â­ï¸" ;;
              *) echo "â“" ;;
            esac
          }

          # Get statuses
          ESLINT_STATUS="${{ needs.eslint.result }}"
          PRETTIER_STATUS="${{ needs.prettier.result }}"

          ESLINT_EMOJI=$(get_status "$ESLINT_STATUS")
          PRETTIER_EMOJI=$(get_status "$PRETTIER_STATUS")

          # Determine overall status
          if [[ "$ESLINT_STATUS" == "success" && "$PRETTIER_STATUS" == "success" ]]; then
            OVERALL="âœ… All Checks Passed"
            OVERALL_EMOJI="ğŸ‰"
          elif [[ "$ESLINT_STATUS" == "failure" || "$PRETTIER_STATUS" == "failure" ]]; then
            OVERALL="âŒ Some Checks Failed"
            OVERALL_EMOJI="ğŸ’”"
          else
            OVERALL="âš ï¸ Some Checks Skipped/Cancelled"
            OVERALL_EMOJI="ğŸ¤”"
          fi

          # Write summary
          cat >> $GITHUB_STEP_SUMMARY << EOF
          # $OVERALL_EMOJI Lint & Format Results

          ## ğŸ“Š Summary

          | Check | Status | Result |
          |-------|--------|--------|
          | ğŸ” ESLint | $ESLINT_EMOJI | \`$ESLINT_STATUS\` |
          | ğŸ¨ Prettier | $PRETTIER_EMOJI | \`$PRETTIER_STATUS\` |

          ---

          ## $OVERALL

          ### ğŸ“‹ Workflow Details

          | Property | Value |
          |----------|-------|
          | ğŸ”€ Branch | \`${{ github.ref_name }}\` |
          | ğŸ“ Commit | \`${{ github.sha }}\` |
          | ğŸ‘¤ Actor | @${{ github.actor }} |
          | ğŸƒ Run ID | [${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) |
          | â±ï¸ Triggered | ${{ github.event_name }} |

          ---

          ### ğŸ› ï¸ Quick Fixes

          If checks failed, run these commands locally:

          \`\`\`bash
          # Fix ESLint issues
          yarn lint --fix

          # Fix Prettier formatting
          yarn fmt
          \`\`\`

          ---

          <sub>ğŸ¤– Generated by GitHub Actions â€¢ Drift CI/CD Pipeline</sub>
          EOF

      - name: Check for failures
        if: needs.eslint.result == 'failure' || needs.prettier.result == 'failure'
        run: |
          echo "âŒ One or more checks failed!"
          exit 1

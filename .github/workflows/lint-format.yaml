name: Lint & Format

on:
  push:
    branches:
      - main
      - develop
    paths:
      - "src/**"
      - "*.js"
      - "*.mjs"
      - "*.ts"
      - "*.json"
      - ".prettierrc"
      - "eslint.config.mjs"
      - ".github/workflows/lint-format.yaml"
  pull_request:
    branches:
      - main
      - develop
    paths:
      - "src/**"
      - "*.js"
      - "*.mjs"
      - "*.ts"
      - "*.json"
      - ".prettierrc"
      - "eslint.config.mjs"
      - ".github/workflows/lint-format.yaml"

env:
  NODE_ENV: development

jobs:
  eslint:
    name: ESLint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "24"
          cache: "yarn"

      - name: Install dependencies
        run: yarn install --immutable

      - name: Generate Prisma Client
        run: yarn prisma generate

      - name: Run ESLint
        run: yarn eslint src --max-warnings 0 --format stylish

  prettier:
    name: Prettier
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "24"
          cache: "yarn"

      - name: Install dependencies
        run: yarn install --immutable

      - name: Check formatting with Prettier
        run: yarn prettier --check --config .prettierrc src

  format-check:
    name: Format Check Summary
    runs-on: ubuntu-latest
    needs: [eslint, prettier]
    if: always()
    steps:
      - name: Check job results
        run: |
          if [[ "${{ needs.eslint.result }}" == "failure" || "${{ needs.prettier.result }}" == "failure" ]]; then
            echo "❌ Lint or format check failed!"
            echo ""
            echo "To fix formatting issues, run:"
            echo "  yarn fmt:lint"
            echo ""
            exit 1
          fi
          echo "✅ All lint and format checks passed!"
